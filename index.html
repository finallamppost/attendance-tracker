<!DOCTYPE html>
<html>
<head>
  <title>Attendance Calendar</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h1>📅 Attendance Calendar</h1>

  <!-- 🔐 Auth Section -->
  <div id="auth-section">
    <button id="login-btn">Sign in with GitHub</button>
    <button id="logout-btn" style="display:none;">Logout</button>
    <p id="user-info"></p>
  </div>

  <!-- 📅 Calendar Controls -->
  <div class="controls" id="calendar-controls" style="display:none;">
    <label for="month">Month:</label>
    <select id="month"></select>

    <label for="year">Year:</label>
    <input type="number" id="year" min="2020" max="2100" value="2025">

    <button onclick="generateCalendar()">Generate Calendar</button>
    <button onclick="exportCSV()">Export CSV</button>
  </div>

  <div id="calendar" class="calendar"></div>

  <h2>📊 Monthly Summary</h2>
  <div id="summary"></div>

  <script>
    // 🔌 Supabase Initialization
    const supabaseUrl = "https://walivuqpkngksvuaosfv.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhbGl2dXFwa25na3N2dWFvc2Z2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwNjksImV4cCI6MjA3MjEyNjA2OX0.QhmBTMRITyc-uMj0FJzYWABEY6Yg2Fp9jECv811Z-PI";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // 🔐 GitHub Login with redirect
    document.getElementById("login-btn").onclick = async () => {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "github",
        options: {
          redirectTo: "https://finallamppost.github.io/attendance-tracker/"
        }
      });
      if (error) console.error("Login error:", error);
    };

    document.getElementById("logout-btn").onclick = async () => {
      await supabase.auth.signOut();
      location.reload();
    };

    // 🧠 Check Auth State
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (session && session.user) {
        document.getElementById("calendar-controls").style.display = "block";
        document.getElementById("logout-btn").style.display = "inline-block";
        document.getElementById("login-btn").style.display = "none";
        document.getElementById("user-info").innerText = `Signed in as ${session.user.email || "GitHub user"}`;
        populateMonthSelector();
        generateCalendar();
      } else {
        document.getElementById("calendar-controls").style.display = "none";
        document.getElementById("logout-btn").style.display = "none";
        document.getElementById("login-btn").style.display = "inline-block";
        document.getElementById("user-info").innerText = "";
      }
    });
  </script>

  <script src="script.js"></script>
</body>
</html>

